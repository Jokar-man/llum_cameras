<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>LLUM-BOT MISSION CONTROL</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body, html { height: 100%; width: 100%; background: #000; overflow: hidden; font-family: 'Courier New', monospace; }
    
    .viewport {
      position: relative; width: 100vw; height: 100vh;
      display: flex; align-items: center; justify-content: center;
      background: radial-gradient(circle, #111 0%, #000 100%);
    }

    #stream, #recorded-video {
      width: 100%; height: 100%; object-fit: fill; z-index: 5;
      transition: filter 0.5s ease;
    }

    /* HUD OVERLAY */
    .hud-overlay {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      pointer-events: none; border: 1px solid rgba(0, 255, 204, 0.2);
      box-shadow: inset 0 0 100px rgba(0, 0, 0, 0.6); z-index: 10;
    }

    .camera-selector, .mode-selector {
      position: absolute; right: 70px; z-index: 20; pointer-events: auto;
      color: #00FFCC; font-size: 14px; display: flex; align-items: center; gap: 10px;
    }
    .camera-selector { top: 30px; }
    .mode-selector { top: 80px; }

    select {
      background: rgba(0, 40, 40, 0.6); color: #00FFCC; border: 1px solid #00FFCC;
      padding: 5px 10px; font-family: inherit; cursor: pointer; outline: none;
      text-transform: uppercase;
    }

    .status-bar {
      position: absolute; top: 30px; left: 70px; color: #00FFCC;
      font-size: 14px; text-transform: uppercase; letter-spacing: 2px;
      text-shadow: 0 0 8px #00FFCC;
    }
    
    .connection-status {
      position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
      color: #00FFCC; font-size: 12px; letter-spacing: 4px; opacity: 0.8;
    }

    .rec-dot {
      display: inline-block; width: 10px; height: 10px;
      background: #FF0000; border-radius: 50%; margin-right: 10px;
      animation: blink 1s infinite;
    }
    
    @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0; } 100% { opacity: 1; } }

    .corner { position: absolute; width: 30px; height: 30px; border: 3px solid #00FFCC; }
    .top-left { top: 20px; left: 20px; border-right: 0; border-bottom: 0; }
    .top-right { top: 20px; right: 20px; border-left: 0; border-bottom: 0; }
    .bottom-left { bottom: 20px; left: 20px; border-right: 0; border-top: 0; }
    .bottom-right { bottom: 20px; right: 20px; border-left: 0; border-top: 0; }
  </style>
</head>
<body>

  <div class="viewport">
    <img id="stream" src="" alt="DATA_STREAM" />
    <video id="recorded-video" loop muted playsinline style="display:none;">
        <source src="recorded video.mp4" type="video/mp4">
    </video>

    <div class="hud-overlay">
        <div class="camera-selector">
            <label>CAM_INPUT_></label>
            <select id="cam-select">
                <option value="192.168.1.199">Robot_cam_1(199)</option>
                <option value="192.168.1.177">Model_cam_1(177)</option>
                <option value="192.168.1.166">Model_cam_2(166)</option>
                <option value="192.168.1.155">Model_cam_3(155)</option>
                <option value="192.168.1.188">Robot_cam_2(188)</option>
                <option value="camcorder">CAMCORDER (REC)</option> 
            </select>
        </div>

        <div class="mode-selector">
            <label>VISION_MODE_></label>
            <select id="vision-mode">
                <option value="normal">NORMAL</option>
                <option value="thermal">THERMAL</option>
                <option value="night">NIGHT_VIS</option>
            </select>
        </div>

        <div class="status-bar"><span class="rec-dot"></span> LIVE // SECURE_FEED // LLUM_BOT_S3</div>
        <div id="conn-stat" class="connection-status">SIGNAL: IDLE</div>
        
        <div class="corner top-left"></div><div class="corner top-right"></div>
        <div class="corner bottom-left"></div><div class="corner bottom-right"></div>
    </div>
  </div>

  <script>
    const img = document.getElementById('stream');
    const videoEl = document.getElementById('recorded-video');
    const connStat = document.getElementById('conn-stat');
    const camSelect = document.getElementById('cam-select');
    const visionSelect = document.getElementById('vision-mode');

    const filters = {
        normal: "none",
        thermal: "brightness(1.1) contrast(1.5) grayscale(1) invert(1) sepia(1) hue-rotate(0deg) saturate(8)",
        night: "sepia(100%) hue-rotate(90deg) brightness(1.2) saturate(2) contrast(1.5)"
    };

    let currentController = null;
    let currentIP = camSelect.value;

    const boundaryBytes = new TextEncoder().encode("--ESP32CAM");
    const headerSepBytes = new TextEncoder().encode("\r\n\r\n");

    function renderJpegBytes(jpegBytes) {
      const url = URL.createObjectURL(new Blob([jpegBytes], { type: "image/jpeg" }));
      const oldUrl = img.src;
      img.src = url;
      if (oldUrl.startsWith("blob:")) URL.revokeObjectURL(oldUrl);
      connStat.innerText = "SIGNAL: NOMINAL";
      connStat.style.color = "#00FFCC";
    }

    async function connectAndStream(ip) {
      if (currentController) currentController.abort();
      currentController = new AbortController();
      
      try {
        const res = await fetch(`http://${ip}/stream`, { signal: currentController.signal });
        const reader = res.body.getReader();
        let buffer = new Uint8Array(0);

        while (true) {
          const { value, done } = await reader.read();
          if (done) break;
          const newBuf = new Uint8Array(buffer.length + value.length);
          newBuf.set(buffer); newBuf.set(value, buffer.length);
          buffer = newBuf;

          while (true) {
            const b0 = buffer.indexOf(boundaryBytes[0]); // Simple search
            if (b0 === -1) break;
            const hs = buffer.indexOf(headerSepBytes[0], b0);
            if (hs === -1) break;
            const b1 = buffer.indexOf(boundaryBytes[0], hs + 4);
            if (b1 === -1) break;

            renderJpegBytes(buffer.slice(hs + 4, b1));
            buffer = buffer.slice(b1);
          }
        }
      } catch (e) { if (e.name !== 'AbortError') setTimeout(() => connectAndStream(ip), 1000); }
    }

    camSelect.addEventListener('change', (e) => {
        currentIP = e.target.value;
        if (currentIP === "camcorder") {
            if (currentController) currentController.abort();
            img.style.display = 'none';
            videoEl.style.display = 'block';
            videoEl.play();
            connStat.innerText = "SIGNAL: LOCAL_PLAYBACK";
        } else {
            videoEl.pause();
            videoEl.style.display = 'none';
            img.style.display = 'block';
            connectAndStream(currentIP);
        }
    });

    visionSelect.addEventListener('change', (e) => {
        const f = filters[e.target.value];
        img.style.filter = f;
        videoEl.style.filter = f;
    });

    if (currentIP !== "camcorder") connectAndStream(currentIP);
  </script>
</body>
</html>
